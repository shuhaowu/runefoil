From d0370e808f4ea5f4e9f4ff7f942ba3ec2ce14fb2 Mon Sep 17 00:00:00 2001
From: Shuhao Wu <shuhao@shuhaowu.com>
Date: Fri, 14 Dec 2018 18:01:22 -0500
Subject: [PATCH] Runefoil base patch set

Things done:

- Allow RuneliteAPI url be configurable via environmental variables
- Patched up Runelite HTTP Service to not crawl prices as the runefoil
  component will do it.
---
 .../net/runelite/http/api/RuneLiteAPI.java    | 21 +++++++--
 .../http/service/item/ItemService.java        | 43 ++++++-------------
 2 files changed, 32 insertions(+), 32 deletions(-)

diff --git a/http-api/src/main/java/net/runelite/http/api/RuneLiteAPI.java b/http-api/src/main/java/net/runelite/http/api/RuneLiteAPI.java
index bc67215..c7b19ec 100644
--- a/http-api/src/main/java/net/runelite/http/api/RuneLiteAPI.java
+++ b/http-api/src/main/java/net/runelite/http/api/RuneLiteAPI.java
@@ -71,17 +71,32 @@ public class RuneLiteAPI
 
 	public static HttpUrl getApiBase()
 	{
-		return HttpUrl.parse(BASE + getVersion());
+		String base = System.getenv("RUNELITE_API_BASE");
+		if (base == null)
+		{
+			base = BASE;
+		}
+		return HttpUrl.parse(base + getVersion());
 	}
 
 	public static HttpUrl getStaticBase()
 	{
-		return HttpUrl.parse(STATICBASE);
+		String base = System.getenv("RUNELITE_STATIC_BASE");
+		if (base == null)
+		{
+			base = STATICBASE;
+		}
+		return HttpUrl.parse(base);
 	}
 
 	public static String getWsEndpoint()
 	{
-		return WSBASE + getVersion() + "/ws";
+		String wsbase = System.getenv("RUNELITE_WS_BASE");
+		if (wsbase == null)
+		{
+			wsbase = WSBASE;
+		}
+		return wsbase + getVersion() + "/ws";
 	}
 
 	public static String getVersion()
diff --git a/http-service/src/main/java/net/runelite/http/service/item/ItemService.java b/http-service/src/main/java/net/runelite/http/service/item/ItemService.java
index 67fac71..79ded56 100644
--- a/http-service/src/main/java/net/runelite/http/service/item/ItemService.java
+++ b/http-service/src/main/java/net/runelite/http/service/item/ItemService.java
@@ -88,7 +88,6 @@ public class ItemService
 	private final CacheService cacheService;
 
 	private final ConcurrentLinkedQueue<PendingLookup> pendingLookups = new ConcurrentLinkedQueue<PendingLookup>();
-	private int[] tradeableItems;
 	private final Random random = new Random();
 
 	@Autowired
@@ -457,35 +456,21 @@ public class ItemService
 				break;
 			case ITEM:
 				fetchItem(pendingLookup.getItemId());
+				// This is a runefoil patched behaviour because we don't run the minio
+				// cache service and thus the reloadItems function won't run (and is
+				// patched out).
+				//
+				// This means that prices will not updated after runelite starts
+				// (runefoil updates the price information before runelite boot, before
+				// the network is locked down, from runelite's API). Adding this line
+				// ensures that the prices might update (keeping in mind that there
+				// are a lot of levels of caches in Runelite that's not patched out,
+				// meaning that the caching mechanism will likely override any sort of
+				// price updates in the server).
+				//
+				// This is an acceptable tradeoff for the time being.
+				fetchPrice(pendingLookup.getItemId());
 				break;
 		}
 	}
-
-	@Scheduled(fixedDelay = 20_000)
-	public void crawlPrices()
-	{
-		if (tradeableItems == null || tradeableItems.length == 0)
-		{
-			return;
-		}
-
-		int idx = random.nextInt(tradeableItems.length);
-		int id = tradeableItems[idx];
-
-		log.debug("Fetching price for {}", id);
-
-		fetchPrice(id);
-	}
-
-	@Scheduled(fixedDelay = 1_8000_000) // 30 minutes
-	public void reloadItems() throws IOException
-	{
-		List<ItemDefinition> items = cacheService.getItems();
-		tradeableItems = items.stream()
-			.filter(item -> item.isTradeable)
-			.mapToInt(item -> item.id)
-			.toArray();
-		log.debug("Loaded {} tradeable items", tradeableItems.length);
-	}
-
 }
-- 
2.19.2

